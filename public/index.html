<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Chonkers | Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-50">
    <nav class="bg-green-800 text-white p-4 shadow-lg flex justify-between items-center">
        <h1 class="text-xl font-black italic">ðŸŒ¿ CASH CHONKERS</h1>
        <div class="text-xs uppercase font-bold tracking-widest bg-green-700 px-3 py-1 rounded">Live Market</div>
    </nav>

    <div class="max-w-5xl mx-auto p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-green-100">
            <h2 class="font-bold text-green-800 mb-4">Farmer Portal</h2>
            <input id="fName" type="text" placeholder="Full Name" class="w-full border p-3 rounded-xl mb-3 focus:outline-green-500">
            <button onclick="register()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700">Get My LEAF-ID</button>
            <div id="idDisplay" class="hidden mt-4 p-4 bg-yellow-100 rounded-xl font-mono text-sm border-2 border-dashed border-yellow-300"></div>
        </div>

        <div class="md:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-green-100">
            <h2 class="font-bold text-green-800 mb-4">Available Bags</h2>
            <div id="market" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>

        <div class="md:col-span-3 bg-slate-900 text-white p-6 rounded-3xl">
            <h2 class="font-bold text-green-400 mb-4">Admin Dashboard (Profit Tracking)</h2>
            <div id="adminTable" class="text-sm font-mono space-y-2"></div>
        </div>
    </div>

    <script>
        async function refresh() {
            const res = await fetch('/api/data');
            const data = await res.json();
            
            document.getElementById('market').innerHTML = data.bags.map(b => `
                <div class="bg-green-50 p-4 rounded-2xl border border-green-200">
                    <p class="font-bold text-green-900">${b.id}</p>
                    <p class="text-3xl font-black my-2">à§³${b.price}</p>
                    <button onclick="buy('${b.id}')" class="w-full bg-white text-green-700 border-2 border-green-700 font-bold py-2 rounded-lg hover:bg-green-700 hover:text-white transition">Buy (bKash)</button>
                </div>
            `).join('');

            document.getElementById('adminTable').innerHTML = data.transactions.map(t => `
                <div class="flex justify-between border-b border-slate-800 pb-2">
                    <span>${t.trxId}</span>
                    <span class="text-green-400">Farmer: +à§³${t.farmerProfit}</span>
                </div>
            `).join('');
        }

        async function register() {
            const name = document.getElementById('fName').value;
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name})
            });
            const d = await res.json();
            const box = document.getElementById('idDisplay');
            box.classList.remove('hidden');
            box.innerHTML = `ID: ${d.userId} <br>PASS: ${d.password}`;
        }

        async function buy(id) {
            await fetch('/api/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({bagId: id})
            });
            alert('bKash Payment Verified!');
            refresh();
        }
        refresh();
    </script>
</body>
</html>